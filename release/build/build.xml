<?xml version="1.0"?>

<project name="Millstone Release" basedir="../" default="all">

    <!-- Default build target -->
    <target name="all" depends="package" description="Build all">
    </target>

    <!-- Initialization - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="pre-init">
        
	<!-- Create current timestamp -->
	<tstamp/>
	
        <!-- Directories -->
        <property name="work-dir" value="build/work"/>
        <property name="original-manifests" value="manifest"/>
        <property name="tmp-dir" value="${work-dir}/tmp"/>
        <property name="checkout-dir" value="${work-dir}/CVS-CHECKOUT"/>

	<!-- Are the compiler optimizations on/off -->
	<property name="optimize" value="off"/>
	
        <!-- Fixed CVS properties -->
	<property name="cvs-root" value=":pserver:anonymous@cvs.sourceforge.net:/cvsroot/millstone"/>

        <!-- Environment -->
	<property environment="env"/>
   
    </target>

    
    <target name="check-version" unless="version" if="release">
        <echo message="You must specify version by setting the 'version' property!"/>
        <echo message="For example: -Dversion=3.0.1"/>
    </target>


    <target name="check-tag" unless="version" if="release">
        <echo message="You must specify CVS tag by setting the 'cvs-tag' property!"/>
        <echo message="For example: -Dcvs-tag=version-3_0_1"/>
    </target>


    <target name="init-release" depends="pre-init,check-version,check-tag" if="release">

        <!-- Create Version filter -->
        <filter token="VERSION" value="${version}"/>

        <!-- Set release base directory -->
        <property name="root-dir" value="${checkout-dir}" />

    	<echo message="Creating MillStone ${version}"/>
	<echo message="Checkout from: ${cvs-root} with tag ${cvs-tag}"/>
	<echo message="Checkout to: ${checkout-dir}" />
	<echo message="Root: ${root-dir}" />
	<echo message="JAVA_HOME: ${env.JAVA_HOME}" />
    </target>


    <target name="init-development" depends="pre-init" unless="release">

        <!-- MillStone version -->
	<property name="version" value="${DSTAMP}.${TSTAMP}" />
	
        <!-- Create Version filter -->
        <filter token="VERSION" value="${version}"/>

        <property name="root-dir" value="." />
        
    	<echo message="Preparing for development snapshot."/>
    	<echo message="Creating MillStone ${version}"/>
	<echo message="Root: ${root-dir}" />
	<echo message="JAVA_HOME: ${env.JAVA_HOME}" />
 	
	<echo message="You can build releases by setting the 'release' property to true."/>
    </target>

    <target name="pause">
        <input message="Press Return key to continue..." />	
    </target>

    <target name="init" depends="init-development,init-release">

        <property name="target-name" value="millstone-${version}"/>
        <property name="release-docs" value="${basedir}/docs"/>

	<!-- Directories -->
        <property name="output-dir" value="${work-dir}/${target-name}"/>
        <property name="manifest-dir" value="${work-dir}/compiled-manifests"/>
      
        <!-- Destination files -->
        <property name="package-file-name" value="${target-name}.zip"/>	
        <property name="base-bin-jar-name" value="millstone-base-${version}.jar"/>
        <property name="base-src-jar-name" value="millstone-base-src-${version}.jar"/>
        <property name="webadapter-bin-jar-name" value="millstone-webadapter-${version}.jar"/>
        <property name="webadapter-src-jar-name" value="millstone-webadapter-src-${version}.jar"/>	
        <property name="web-themes-jar-name" value="millstone-web-themes-${version}.jar"/>
        <property name="examples-jar-name" value="millstone-examples-${version}.jar"/>
        <property name="examples-war-name" value="millstone-examples-${version}.war"/>

        <echo message="Prepared to build MillStone ${version} packages"/>
       
    </target>



    <!-- Intialize Working Directory -->

    <target name="init-work-dir" depends="init,pause"
            description="Create release working Directory structure">

    	<!-- Create working directory -->
        <mkdir dir="${work-dir}" />
        
		<!-- Create manifest directory -->
		<mkdir dir="${manifest-dir}" />
	
    </target>
    


    <!-- Initialize Output Directory -->
    
    <target name="init-output-dir" depends="init-work-dir"
            description="Create release working Sirectory structure">

        <!-- Copy/filter core documentation to correct places -->
        <copy todir="${output-dir}">
	    <filterset>
    	       <filter token="VERSION" value="${version}"/>
            </filterset>
            <fileset dir="${release-docs}">
                <include name="readme.txt"/>
                <include name="install.txt"/>
                <include name="license.txt"/>
                <include name="release-notes.txt"/>
                <include name="changes.txt"/>
            </fileset>
        </copy>
	
        <!-- Convert to CRLF -->
        <fixcrlf srcdir="${output-dir}"
                 eol="crlf"
		 tablength="4"
		 tab="remove"
	         includes="*.txt"/>
	
        <!-- Create Output Directory Hierarchy -->
        <mkdir dir="${output-dir}/docs/apidocs" />
        <mkdir dir="${output-dir}/lib" />
    
    </target>
    
    
    <!-- Target for generation manifest file
  			parameters: name,title -->
    <target name="generate-manifest">
		<manifest file="${manifest-dir}/${file}">
    		<attribute name="Built-By" value="${user.name}"/>
    		<section name="${name}">
      		<attribute name="Specification-Title" value="${spec-title}"/>
      		<attribute name="Specification-Version" value="${version}"/>
      		<attribute name="Specification-Vendor" value="IT Mill Ltd"/>
      		<attribute name="Implementation-Title" value="${impl-title}"/>
      		<attribute name="Implementation-Version" value="${version}"/> 
      		<attribute name="Implementation-Vendor" value="IT Mill Ltd"/>
    		</section>
		</manifest>
    </target>

    
    
    <!-- Base - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="base" depends="init-output-dir">
		<antcall target="generate-manifest">
			<param name="file" value="millstone-base-src.mf"/>
			<param name="name" value="org/millstone/base"/>
			<param name="spec-title" value="Millstone Base"/>
			<param name="impl-title" value="org.millstone.base"/>
	  	</antcall>
	  	<antcall target="generate-manifest">
			<param name="file" value="millstone-base-bin.mf"/>
			<param name="name" value="org/millstone/base"/>
			<param name="spec-title" value="Millstone Base"/>
			<param name="impl-title" value="org.millstone.base"/>
	  	</antcall>
        <ant antfile="build/build-base.xml" inheritAll="true" />
    </target>
    
    <!-- Web adapter- - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="webadapter" depends="base">
		<antcall target="generate-manifest">
			<param name="file" value="millstone-webadapter-bin.mf"/>
			<param name="name" value="org/millstone/webadapter"/>
			<param name="spec-title" value="Millstone Web Adapter"/>
			<param name="impl-title" value="org.millstone.webadapter"/>
	  	</antcall>
	  	<antcall target="generate-manifest">
			<param name="file" value="millstone-webadapter-src.mf"/>
			<param name="name" value="org/millstone/webadapter"/>
			<param name="spec-title" value="Millstone Web Adapter"/>
			<param name="impl-title" value="org.millstone.webadapter"/>
	  	</antcall>
	  	<antcall target="generate-manifest">
			<param name="file" value="millstone-web-themes.mf"/>
			<param name="name" value="org/millstone/webadapter/themes"/>
			<param name="spec-title" value="Millstone Web Adapter Themes"/>
			<param name="impl-title" value="org.millstone.webadapter.themes"/>
	  	</antcall>
       <ant antfile="build/build-webadapter.xml" inheritAll="true" />
    </target>


    <!-- Documentation- - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="docs" depends="base,webadapter">
        <ant antfile="build/build-docs.xml" inheritAll="true" />
    </target>

    <!-- Examples - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="examples" depends="init-output-dir,base,webadapter">
  	  	<antcall target="generate-manifest">
			<param name="file" value="millstone-examples.mf"/>
			<param name="name" value="org/millstone/examples"/>
			<param name="spec-title" value="Millstone Examples"/>
			<param name="impl-title" value="org.millstone.examples"/>
	  	</antcall>
       <ant antfile="build/build-examples.xml" inheritAll="true" />
    </target>


    <!-- ZIP Package creation - - - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="package" depends="init-output-dir,docs,base,webadapter,examples">
        <zip zipfile="${work-dir}/${package-file-name}">
	     <fileset dir="${work-dir}">
              <patternset>
                <include name="${target-name}/**"/>
              </patternset>
            </fileset>
	 </zip>
    </target>
    


    <!-- Cleaning up the mess - - - - - - - - - - - - - - - - - - - - - - - -->

    <target name="clean" depends="init">
        <echo message="Deleting build directory"/>
        <delete dir="${work-dir}" />
    </target>
    
</project>
